name: ðŸ§¬ Build APK â€” EvoluÃ§Ã£o Real

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:   # permite rodar manualmente

jobs:
  build-apk:
    name: Build Android APK
    runs-on: ubuntu-22.04

    steps:
      # â”€â”€ 1. Baixar cÃ³digo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      # â”€â”€ 2. Configurar Java (necessÃ¡rio para Android SDK) â”€â”€â”€
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # â”€â”€ 3. Configurar Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # â”€â”€ 4. Cache do Buildozer (acelera builds futuros) â”€â”€â”€â”€
      - name: ðŸ’¾ Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            ~/.gradle
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            buildozer-${{ runner.os }}-

      # â”€â”€ 5. DependÃªncias do sistema (Android NDK/SDK deps) â”€â”€
      - name: ðŸ“¦ Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git zip unzip openjdk-17-jdk wget \
            libgl1-mesa-dev libgles2-mesa-dev \
            libffi-dev libssl-dev \
            python3-pip python3-dev \
            build-essential ccache \
            autoconf automake libtool \
            zlib1g-dev \
            lld

      # â”€â”€ 6. Instalar Buildozer e Cython â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”§ Instalar Buildozer
        run: |
          pip install --upgrade pip setuptools wheel
          pip install buildozer cython==0.29.37

      # â”€â”€ 7. Build do APK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ—ï¸ Build APK (modo debug)
        run: |
          buildozer -v android debug 2>&1 | tee build.log
        env:
          ANDROIDAPI:    "33"
          ANDROIDMINAPI: "21"

      # â”€â”€ 8. Upload do APK como artefato do GitHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: EvolucaoReal-APK
          path: bin/*.apk
          retention-days: 30

      # â”€â”€ 9. Upload do log em caso de falha â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“‹ Upload log de build (se falhou)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

      # â”€â”€ 10. Criar Release automÃ¡tico em push na main â”€â”€â”€â”€â”€â”€
      - name: ðŸš€ Criar GitHub Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "ðŸ§¬ EvoluÃ§Ã£o Real v${{ github.run_number }}"
          body: |
            ## ðŸ§¬ EvoluÃ§Ã£o Real â€” Build automÃ¡tico

            **Commit:** ${{ github.sha }}
            **Data:** ${{ github.event.repository.updated_at }}

            ### Como instalar:
            1. Baixe o arquivo `.apk` abaixo
            2. No Android: ConfiguraÃ§Ãµes â†’ SeguranÃ§a â†’ **Fontes desconhecidas** âœ…
            3. Abra o arquivo `.apk` e instale
            4. Divirta-se evoluindo vida! ðŸ§¬
          files: bin/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
